/* board.c */
#include <rtthread.h>
#include <rthw.h>
#include "stm32h7xx_hal.h" 

/* ?? HAL ?????????? (? CubeMX ??? main.c ?) */
extern void SystemClock_Config(void);

/* ????????,????? malloc ???? */
#define HEAP_BEGIN  ((void *)&Image$$RW_IRAM1$$ZI$$Limit)
#define HEAP_END    (void *)(0x24000000 + 512 * 1024) /* ??? AXI SRAM */

/**
 * RT-Thread ???????
 */
void rt_hw_board_init(void)
{
    /* 1. ??? HAL ? */
    HAL_Init();

    /* 2. ?????? (?? main.c ????) */
    SystemClock_Config();

    /* 3. ????????? (SysTick) ?? RT-Thread ??? */
    /* STM32H7 ???? 400MHz, /1000 = 1ms ???? */
    HAL_SYSTICK_Config(HAL_RCC_GetHCLKFreq() / RT_TICK_PER_SECOND);
    /* ?? SysTick ??????,??????? */
    HAL_NVIC_SetPriority(SysTick_IRQn, 15, 0);

    /* 4. ?????? (? rt_malloc ??) */
    // rt_system_heap_init(HEAP_BEGIN, HEAP_END); 
    /* ?????????,???????,?????????????? */

    /* 5. ????? (? rt_kprintf ??) */
    /* ?????? component ???????,?????? MX_USART1_UART_Init */
    
#ifdef RT_USING_COMPONENTS_INIT
    rt_components_board_init();
#endif

#ifdef RT_USING_CONSOLE
    /* ????????? "uart1" */
    rt_console_set_device("uart1");
#endif
}

/* * ????? SysTick ?????? 
 * (???? stm32h7xx_it.c ???????,?????,??????!)
 */
void SysTick_Handler(void)
{
    /* ?? RT-Thread:??????? tick */
    rt_interrupt_enter();
    rt_tick_increase();
    rt_interrupt_leave();
    
    /* ???? HAL ??? (?? HAL_Delay) */
    HAL_IncTick();
}